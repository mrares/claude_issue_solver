# This Dockerfile extends the development Dockerfile from the target repository
# It adds Claude CLI and necessary configurations for the issue solver

# ARG will be passed during build to specify the base development Dockerfile
ARG DEV_DOCKERFILE_PATH=./Dockerfile

# Import the development environment
FROM dev-base as development

# Install GitHub CLI (gh)
RUN apt-get update && \
    apt-get install -y curl && \
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
    chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
    apt-get update && \
    apt-get install -y gh && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create a non-root user for Claude (required for --dangerously-skip-permissions)
RUN useradd -m -s /bin/bash claude && \
    mkdir -p /home/claude/.claude && \
    chown -R claude:claude /home/claude

# Switch to claude user for installation
USER claude
WORKDIR /home/claude

# Copy the Claude install script (downloaded locally before build)
COPY --chown=claude:claude claude-install.sh /tmp/claude-install.sh
RUN chmod +x /tmp/claude-install.sh && /tmp/claude-install.sh && rm /tmp/claude-install.sh

# Ensure Claude CLI is in PATH
ENV PATH="/home/claude/.local/bin:${PATH}"

# Set up git config for commits
RUN git config --global user.name "Claude Issue Solver" && \
    git config --global user.email "claude-bot@anthropic.com"

# Create workspace directory with proper ownership
USER root
RUN mkdir -p /workspace && chown claude:claude /workspace
USER claude

WORKDIR /workspace

# The entry point will be set when running the container
# to execute Claude with appropriate prompts
ENTRYPOINT ["/home/claude/.local/bin/claude"]
